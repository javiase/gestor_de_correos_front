<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Store Settings + Formulario Deslizante + Expansi√≥n de tarjetas</title>
  <style>
    /* Importamos la fuente Poppins (opcional) */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap');

    /********************************************
     * RESET B√ÅSICO
    ********************************************/
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /********************************************
     * BODY (Pantalla completa, sin scroll global)
    ********************************************/
    body {
      height: 100vh;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #1C1C1C;
      color: #fff;
    }

    .container {
      position: relative;
      min-height: 100vh;
    }

    /********************************************
     * CABECERA (header)
    ********************************************/
    header {
      background-color: #242424;
      /* Antes: padding: 1.6vh 0; => Aumentamos ~1.25x */
      padding: 2vh 0;
      z-index: 10;
      width: 100%;
    }
    .header-container {
      /* Antes: padding: 0 3.2vh; => ~4vh */
      padding: 0 4vh;
      margin: 0 auto;
      display: flex;
      align-items: center;
    }
    nav {
      /* Antes: gap: 3.2vh => ~4vh */
      display: flex;
      gap: 4vh;
      margin-right: auto;
    }
    .btn-secondary {
      text-decoration: none; /* Quita el subrayado */
      font-weight: 600;
      /* Antes: font-size: 1.6vh => ~2vh */
      font-size: 2vh;
      background-color: #2C2C2C;
      color: #fff;
      border: none;
      /* Antes: padding: 1.2vh 2.4vh => ~1.5vh 3vh */
      padding: 1.5vh 3vh;
      /* Antes: border-radius: 0.8vh => ~1vh */
      border-radius: 1vh;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      /* Antes: box-shadow: 0 0.4vh 1vh => ~0 0.5vh 1.25vh */
      box-shadow: 0 0.5vh 1.25vh rgba(0,0,0,0.3);
    }
    .btn-secondary:hover {
      background-color: #3C3C3C;
    }
    /* NUEVO BOT√ìN: Reemplaza el c√≠rculo con la U */
    .btn {
      display: inline-block;
      padding: 0.9vh 1.8vh;
      font-size: 16px;
      font-weight: 700;
      color: white;
      border: 3px solid #059669; /* Verde utilizado en otros sitios */
      cursor: pointer;
      position: relative;
      background-color: transparent;
      text-decoration: none;
      overflow: hidden;
      border-radius: 0.4vh;
      z-index: 1;
      font-family: inherit;
    }
    .btn::before {
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: #059669;
      transform: translateX(-100%);
      transition: all .3s;
      z-index: -1;
    }
    .btn:hover::before {
      transform: translateX(0);
    }
    /********************************************
     * STORE-PAGE
       - Se mueve con transform cuando se expande una card
    ********************************************/
    .store-page {
      position: relative;
      width: 100%;
      transition: transform 0.4s ease;
    }
    .store-page.shifted-up {
      transform: translateY(-12vh);
    }

    /* Contenedor interno de la store-page */
    .main-content {
      max-width: 112vh;
      margin: 0 auto;
      padding: 3vh;
      padding-top: 16vh;
    }

    .main-heading {
      margin-bottom: 4vh;
      text-align: center;
      transition: opacity 0.3s ease;
    }
    .main-heading h1 {
      font-size: 3vh;
      font-weight: 500;
      margin-bottom: 2vh;
    }
    .main-heading p {
      color: #9CA3AF;
      font-size: 1.8vh;
      line-height: 1.4;
    }
    .hidden-heading {
      display: none;
    }

    /********************************************
     * CUADRO "SIN TIENDA": .no-store-container
    ********************************************/
    .no-store-container {
      width: 100%;
      display: none; /* Por defecto oculto, lo muestra JS si no hay tienda */
      text-align: center;
      margin-bottom: 4vh;
    }
    .no-store-box {
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 90%;
      max-width: 70vh;
      border: 2px dashed #059669;
      padding: 5vh 3vh;
      border-radius: 1.5vh;
      animation: blink-border 1.5s infinite;
      margin: 0 auto;
      cursor: pointer;
    }
    .no-store-box h2 {
      margin-bottom: 2vh;
      font-size: 2.2vh;
    }
    .plus-icon {
      width: 4vh;
      height: 4vh;
      stroke: #4B5563;
    }
    .connect-google-container {
      background-color: #242424;
      border-radius: 1.5vh;
      padding: 4vh;
      box-shadow: 0 0.5vh 1.5vh rgba(0,0,0,0.4);
      text-align: center;
      max-width: 60vh;
      margin: 4vh auto; /* Centrado */
    }
    @keyframes blink-border {
      0% { border-color: #10B981; }
      50% { border-color: transparent; }
      100% { border-color: #10B981; }
    }
    
    /********************************************
     * info-container / cards (CUANDO S√ç HAY TIENDA)
    ********************************************/
    .info-container {
      background-color: #242424;
      padding: 4vh;
      border-radius: 1.5vh;
      position: relative;
      margin-bottom: 4vh;
      display: none; /* Se muestra si hay tienda */
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2vh;
      position: relative;
    }

    .card {
      background-color: #2C2C2C;
      border: none;
      padding: 3vh;
      box-shadow: 0 0.5vh 1.25vh rgba(0,0,0,0.3);
      transition: background-color 0.2s ease-in-out, transform 0.4s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 15vh;
      border-radius: 0.75vh;
      position: relative;
      z-index: 1;
    }
    .card:hover {
      background-color: #3C3C3C;
    }
    .card h2 {
      font-size: 2.25vh;
      font-weight: 500;
      text-align: center;
      font-family: sans-serif;
    }

    /* Bot√≥n \"agregar\" => .add-card */
    .add-card {
      border: 0.25vh dashed #4B5563;
      background: none;
    }
    .add-card h2 {
      display: none;
    }
    .add-card.expanded h2 {
      display: block;
      color: #999;
    }
    .plus-icon { /* Reutilizado de antes */ }

    /* Flecha para colapsar */
    .arrow-collapse {
      display: none;
      position: absolute;
      top: 2vh;
      left: 2vh;
      width: 3vh;
      height: 3vh;
      cursor: pointer;
    }
    .arrow-collapse svg {
      width: 100%;
      height: 100%;
      stroke: #fff;
    }
    .arrow-collapse:hover {
      opacity: 0.8;
    }

    /* Contenido expandido */
    .expand-content {
      display: none;
    }
    .expand-content textarea {
      display: block;
      background-color: #2C2C2C;
      border: 0.12vh solid #3C3C3C;
      border-radius: 1vh;
      color: #fff;
      padding: 2vh;
      font-size: 1.8vh;
      resize: none;
      margin: 0 auto;
      margin-top: 2vh; 
      width: 100%;
      min-height: 48vh;
    }
    .expand-content .send-button {
      display: block;
      background-color: #059669;
      border: none;
      border-radius: 1vh;
      color: #fff;
      font-family: sans-serif;
      font-size: 2vh;
      padding: 1vh 2vh;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin: 1.6vh auto 0 auto;
    }
    .expand-content .send-button:hover {
      background-color: #047450;
    }

    /* Card expandida */
    .cards-grid.expanded .card:not(.expanded) {
      opacity: 0;
      pointer-events: none;
    }
    .card.expanded {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      cursor: auto;
      height: auto;
      min-height: 100%;
      border-radius: 1.5vh;
      z-index: 2;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      background-color: #2C2C2C;
      transition: all 0.4s ease;
      padding: 4vh;
    }
    .card.expanded .arrow-collapse {
      display: block;
    }
    .card.expanded:not(.add-card) .edit-title-btn {
      display: block;
    }
    .card.expanded h2 {
      position: relative;
      margin: 0 auto;
      text-align: center;
      font-size: 2.25vh;
      font-weight: 600;
      width: fit-content;
    }
    .card.expanded .expand-content {
      display: block;
      width: 100%;
    }
    /* Bot√≥n editar (solo en cards normales) */
    .edit-title-btn {
      position: absolute;
      top: 2.4vh;
      right: 2.4vh;
      font-family: sans-serif;
      font-size: 1.6vh;
      background-color: #3C3C3C;
      color: #fff;
      border: none;
      border-radius: 0.5vh;
      padding: 0.6vh 1.2vh;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .edit-title-btn:hover {
      background-color: #555;
    }
    /* Bot√≥n editar (solo en cards normales) */
    .a√±adir-faq-btn {
      font-family: sans-serif;
      font-size: 1.6vh;
      background-color: #3C3C3C;
      color: #fff;
      border: none;
      border-radius: 0.5vh;
      padding: 0.6vh 1.2vh;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .a√±adir-faq-btn:hover {
      background-color: #555;
    }

    /********************************************
     * FLECHAS PARA CAMBIAR PANTALLAS
    ********************************************/
    .arrow-right {
      position: absolute;
      top: 50%;
      right: -10vh;
      transform: translateY(-50%);
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .arrow-right svg {
      width: 4vh;
      height: 4vh;
      stroke: #fff;
    }
    .arrow-right:hover {
      opacity: 0.8;
    }

    .arrow-left {
      position: absolute;
      top: 50%;
      left: -10vh; 
      transform: translateY(-50%);
      cursor: pointer;
      transition: opacity 0.2s ease;
    }
    .arrow-left svg {
      width: 4vh;
      height: 4vh;
      stroke: #fff;
    }
    .arrow-left:hover {
      opacity: 0.8;
    }

    .hidden {
      display: none !important;
    }

    /********************************************
     * FORM-PAGE (segunda pantalla deslizante)
    ********************************************/
    .form-page {
      position: absolute;
      top: 0;
      left: 100%;
      width: 100%;
      min-height: 100vh;
      display: flex;
      align-items: center;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 16vh;
      background-color: #1C1C1C;
      transition: transform 0.4s ease;
      z-index: 5;
    }

    /* NUEVO: para tener 2 \"cuadrados\" uno al lado del otro */
    .forms-row {
      display: flex;
      gap: 2vh;
      position: relative; 
      /* Ponemos position relative para acomodar items si necesitamos */
    }

    .form-container {
      /* Cada \"cuadrado\" es un contenedor con su fondo etc. */
      background-color: #242424;
      font-family: sans-serif;
      font-weight: 600;
      border-radius: 1.5vh;
      box-shadow: 0 0.5vh 1.5vh rgba(0,0,0,0.4);
      width: 45vh; /* Ajusta a tu gusto el ancho de cada \"cuadro\" */
      padding: 4vh;
      /* Podr√≠as usar un max-height si deseas. */
    }
    .form-container h2 {
      font-size: 2.5vh;
      margin-bottom: 2vh;
      text-align: center;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 2vh;
    }
    .form-group label {
      font-size: 1.8vh;
      color: #ccc;
      margin-bottom: 0.5vh;
    }
    .form-group input {
      border: 0.12vh solid #3C3C3C;
      background-color: #2C2C2C;
      padding: 1vh;
      border-radius: 0.5vh;
      color: #fff;
      font-size: 1.8vh;
    }
    .form-group input:focus {
      border-color: #10B981;
      outline: none;
    }
    .buttons-container {
      display: flex;
      justify-content: space-between;
      gap: 2vh; /* Espacio entre botones */
    }

    .delete-button {
      background-color: #B91C1C; /* Rojo de advertencia */
      border: none;
      border-radius: 0.5vh;
      color: #fff;
      font-size: 2vh;
      padding: 1vh 2vh;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .delete-button:hover {
      background-color: #991B1B; /* Rojo m√°s oscuro al pasar el mouse */
    }
    .save-button {
      background-color: #10B981;
      border: none;
      border-radius: 0.5vh;
      color: #fff;
      font-size: 2vh;
      padding: 1vh 2vh;
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-top: 1vh;
    }
    .save-button:hover {
      background-color: #059669;
    }

    /* Transiciones */
    .slide-out-left {
      transform: translateX(-100%);
    }
    .slide-in-left {
      transform: translateX(-100%);
    }
    .slide-out-right {
      transform: translateX(0);
    }

    /* MEN√ö DESPLEGABLE */
    .dropdown-menu {
      position: absolute;
      top: 6vh; 
      right: 4vh;
      background-color: #2C2C2C;
      border-radius: 0.5vh;
      box-shadow: 0 0.5vh 1vh rgba(0,0,0,0.3);
      min-width: 20vh;
      z-index: 99;
      font-family: sans-serif;
      transition: opacity 0.2s ease;
    }
    .dropdown-menu ul {
      list-style: none;
      margin: 0;
      padding: 1vh 0;
    }
    .dropdown-menu li {
      margin: 0;
      padding: 0;
    }
    .dropdown-menu a {
      display: block;
      text-decoration: none;
      color: #fff;
      padding: 1vh 2vh;
      transition: background-color 0.2s ease;
    }
    .dropdown-menu a:hover {
      background-color: #3C3C3C;
    }
    .hidden {
      display: none !important;
    }
    /********************************************
     * FAQS
    ********************************************/
    #faqContainer {
      max-height: 44vh;   /* Ajusta seg√∫n tu preferencia */
      overflow-y: auto;   /* Permite el scroll vertical */
      padding-right: 1vh; /* A√±ade un peque√±o padding para que el scroll no tape texto */
      padding-bottom: 1vh;
    }

    /********************************************
     * loader
    ********************************************/
    .loading-spinner {
      /* color used to softly clip top and bottom of the .words container */
      --bg-color: #2C2C2C;
      background-color: var(--bg-color);
      padding: 1rem 2rem;
      border-radius: 1.25rem;
      display: flex;
      align-items: flex-end;
      flex-direction: column;
      margin-top: 5vh;
    }
    .loader {
      color: rgb(124, 124, 124);
      font-family: "Poppins", sans-serif;
      font-weight: 500;
      font-size: 25px;
      -webkit-box-sizing: content-box;
      box-sizing: content-box;
      height: 40px;
      padding: 10px 10px;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      border-radius: 8px;
    }

    .words {
      overflow: hidden;
      position: relative;
    }
    .words::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 20;
    }

    .word {
      display: block;
      height: 100%;
      padding-left: 6px;
      color: #059669;
      animation: spin_4991 8s infinite;
    }

    @keyframes spin_4991 {
      10% {
        -webkit-transform: translateY(-102%);
        transform: translateY(-102%);
      }

      25% {
        -webkit-transform: translateY(-100%);
        transform: translateY(-100%);
      }

      35% {
        -webkit-transform: translateY(-202%);
        transform: translateY(-202%);
      }

      50% {
        -webkit-transform: translateY(-200%);
        transform: translateY(-200%);
      }

      60% {
        -webkit-transform: translateY(-302%);
        transform: translateY(-302%);
      }

      75% {
        -webkit-transform: translateY(-300%);
        transform: translateY(-300%);
      }

      85% {
        -webkit-transform: translateY(-402%);
        transform: translateY(-402%);
      }

      100% {
        -webkit-transform: translateY(-400%);
        transform: translateY(-400%);
      }
    }
    /********************************************
     * checklist missing info
    ********************************************/
    /* === Ajusta a tu gusto el tama√±o y las animaciones === */
    #checklist {
      --background: #2C2C2C;
    --text: #ffffff;
    --check: #059669;
    --disabled: #c3c8de;
    --width: auto;
    --height: auto;
    /* --border-radius: 2vh; */
    background: var(--background);
    width: var(--width);
    height: var(--height);
    border-radius: var(--border-radius);
    position: relative;
    padding: 3vh 4vh 0vh 4vh;    
    display: grid;
    grid-template-columns: 2.5vh auto;
    justify-content: center;
    overflow-y: auto;
    }

    /* Ocupa cada fila */
    #checklist input,
    #checklist label {
      margin-bottom: 1vh;
    }

    /* Estilos del label */
    #checklist label {
      color: var(--text);
      position: relative;
      cursor: pointer;
      display: grid;
      align-items: center;
      width: fit-content;
      transition: color 0.3s ease;
      margin-right: 2vh;
    }

    #checklist label::before,
    #checklist label::after {
      content: "";
      position: absolute;
    }

    #checklist label::before {
      height: 0.2vh;
      width: 0.8vh;
      left: -2.7vh;
      background: var(--check);
      border-radius: 2px;
      transition: background 0.3s ease;
    }

    #checklist label::after {
      height: 0.4vh;
      width: 0.4vh;
      top: 0.8vh;
      left: -2.5vh;
      border-radius: 50%;
    }

    /* Estilos del input (checkbox) */
    #checklist input[type="checkbox"] {
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
      height: 1.5vh;
      width: 1.5vh;
      outline: none;
      border: 0;
      margin: 0 2vh 0 0;
      cursor: pointer;
      background: var(--background);
      display: grid;
      align-items: center;
    }

    #checklist input[type="checkbox"]::before,
    #checklist input[type="checkbox"]::after {
      content: "";
      position: absolute;
      height: 0.2vh;
      top: auto;
      background: var(--check);
      border-radius: 2px;
    }

    #checklist input[type="checkbox"]::before {
      width: 0;
      right: 60%;
      transform-origin: right bottom;
    }

    #checklist input[type="checkbox"]::after {
      width: 0;
      left: 40%;
      transform-origin: left bottom;
    }

    /* Cu√°ndo est√° checkeado */
    #checklist input[type="checkbox"]:checked::before {
      animation: check-01 0.4s ease forwards;
    }

    #checklist input[type="checkbox"]:checked::after {
      animation: check-02 0.4s ease forwards;
    }

    #checklist input[type="checkbox"]:checked + label {
      color: var(--disabled);
      animation: move 0.3s ease 0.1s forwards;
    }

    #checklist input[type="checkbox"]:checked + label::before {
      background: var(--disabled);
      animation: slice 0.4s ease forwards;
    }

    #checklist input[type="checkbox"]:checked + label::after {
      animation: firework 0.5s ease forwards 0.1s;
    }

    /* Keyframes adaptados */
    @keyframes move {
      50% {
        padding-left: 0.8vh;
        padding-right: 0vh;
      }
      100% {
        padding-right: 0.4vh;
      }
    }

    @keyframes slice {
      60% {
        width: 100%;
        left: 0.4vh;
      }
      100% {
        width: 100%;
        left: -0.2vh;
      }
    }

    @keyframes check-01 {
      0% {
        width: 0.4vh;
        top: auto;
        transform: rotate(0);
      }
      50% {
        width: 0vh;
        top: auto;
        transform: rotate(0);
      }
      51% {
        width: 0vh;
        top: 0.8vh;
        transform: rotate(45deg);
      }
      100% {
        width: 0.5vh;
        top: 0.8vh;
        transform: rotate(45deg);
      }
    }

    @keyframes check-02 {
      0% {
        width: 0.4vh;
        top: auto;
        transform: rotate(0);
      }
      50% {
        width: 0vh;
        top: auto;
        transform: rotate(0);
      }
      51% {
        width: 0vh;
        top: 0.8vh;
        transform: rotate(-45deg);
      }
      100% {
        width: 1vh;
        top: 0.8vh;
        transform: rotate(-45deg);
      }
    }

    @keyframes firework {
      0% {
        opacity: 1;
        box-shadow: 0 0 0 -0.2vh #4f29f0,
                    0 0 0 -0.2vh #4f29f0,
                    0 0 0 -0.2vh #4f29f0,
                    0 0 0 -0.2vh #4f29f0,
                    0 0 0 -0.2vh #4f29f0,
                    0 0 0 -0.2vh #4f29f0;
      }
      30% {
        opacity: 1;
      }
      100% {
        opacity: 0;
        box-shadow: 0 -1.5vh 0 0 #4f29f0,
                    1.4vh -0.8vh 0 0 #4f29f0,
                    1.4vh 0.8vh 0 0 #4f29f0,
                    0 1.5vh 0 0 #4f29f0,
                    -1.4vh 0.8vh 0 0 #4f29f0,
                    -1.4vh -0.8vh 0 0 #4f29f0;
      }
    }


  </style>
</head>

<body id="app">  <!-- HEADER -->
  <header>
    <div class="header-container">
      <nav>
        <a class="btn-secondary" href="http://localhost:3000/principal.html">Correos</a>
        <a class="btn-secondary" href="http://localhost:3000/plans.html">Planes</a>
        <button class="btn-secondary" id="btnAnaliticas">An√°lisis</button>
      </nav>
      <a class="btn" href="#" id="storeNameCorner"></a>
      <div class="dropdown-menu hidden" id="userDropdownMenu">
        <ul>
          <li><a href="#" id="logoutBtn">Cerrar sesi√≥n</a></li>
        </ul>
      </div>
    </div>
  </header>

  <div class="container">

    <!-- PANTALLA PRINCIPAL (STORE-PAGE) -->
    <div class="store-page" id="storePage">
      <div class="main-content">
        <!-- Texto Superior -->
        <div class="main-heading" id="mainHeading">
          <h1>Informacion sobre la tienda</h1>
          <p>
            En esta seccion tienes que a√±adir toda la informacion de la tienda que tengas,
            incluyendo todas las pol√≠ticas y informacion extra que se te va a pedir
          </p>
        </div>
        <!-- info-container (tarjetas) si hay tienda -->
        <div class="info-container" id="infoContainer" style="display: block;">
          <div class="cards-grid" id="cardsGrid">
            <!-- Card 1 -->
            <div class="card" data-policy-type="devoluciones">
              <div class="arrow-collapse">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                     stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     viewBox="0 0 24 24">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
              </div>
              <h2>Politica de Devoluciones</h2>
              <div class="expand-content">
                <textarea placeholder="Escribe tu texto aqui..."></textarea>
                <button class="send-button">Enviar</button>
                <!-- Icono de carga (por defecto hidden) -->
                <div class="loading-spinner hidden">
                  <div class="loader">
                    <p>Estamos</p>
                    <div class="words">
                      <span class="word">comprobando que tus datos est√©n completos...</span>
                      <span class="word">revisando que no falte nada...</span>
                      <span class="word">comparando con nuestra base de datos...</span>
                      <span class="word">preparando el feedback...</span>
                      <span class="word">comprobando que tus datos est√©n completos...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Card 2 -->
            <div class="card" data-policy-type="envios">
              <div class="arrow-collapse">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                     stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     viewBox="0 0 24 24">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
              </div>
              <h2>Politica de Envios</h2>
              <div class="expand-content">
                <textarea placeholder="Escribe tu texto aqui..."></textarea>
                <button class="send-button">Enviar</button>
                  <!-- Icono de carga (por defecto hidden) -->
                  <div class="loading-spinner hidden">
                    <div class="loader">
                      <p>Estamos</p>
                      <div class="words">
                        <span class="word">comprobando que tus datos est√©n completos...</span>
                        <span class="word">revisando que no falte nada...</span>
                        <span class="word">comparando con nuestra base de datos...</span>
                        <span class="word">preparando el feedback...</span>
                        <span class="word">comprobando que tus datos est√©n completos...</span>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
            <!-- Card 3 -->
            <div class="card" data-policy-type="info">
              <div class="arrow-collapse">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                     stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     viewBox="0 0 24 24">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
              </div>
              <h2>Info general de la tienda</h2>
              <div class="expand-content">
                <textarea placeholder="Escribe tu texto aqui..."></textarea>
                <button class="send-button">Enviar</button>
                  <!-- Icono de carga (por defecto hidden) -->
                  <div class="loading-spinner hidden">
                    <div class="loader">
                      <p>Estamos</p>
                      <div class="words">
                        <span class="word">comprobando que tus datos est√©n completos...</span>
                        <span class="word">revisando que no falte nada...</span>
                        <span class="word">comparando con nuestra base de datos...</span>
                        <span class="word">preparando el feedback...</span>
                        <span class="word">comprobando que tus datos est√©n completos...</span>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
            <!-- Card 4: Preguntas Frecuentes -->
            <div class="card" id="faqCard" faq="faq">
              <div class="arrow-collapse">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    viewBox="0 0 24 24">
                  <line x1="19" y1="12" x2="5" y2="12"></line>
                  <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
              </div>
              <h2>Preguntas Frecuentes</h2>
              <div class="expand-content">
                <p style="margin-bottom: 4vh;margin-top: 4vh;text-align: center;">
                  En esta secci√≥n se encuentran preguntas frecuentes las cuales puedes responder
                  para agilizar las respuestas del bot. Tambi√©n puedes a√±adir las tuyas propias.
                </p>
                <div id="faqContainer">
                  <div id = "faqBlocks">
                    <!-- Pregunta/Respuesta 1 -->
                    <div class="faq-block" style="position: relative; margin-bottom: 3vh; padding-left: 1vh;">
                      <div>
                        <p class="faq-question-text" style="width: fit-content;">¬øC√≥mo rastrear mi pedido?</p>
                        <button class="edit-faq-btn edit-title-btn" style="position:absolute; top:0; right:10vh;">Editar</button>
                        <button class="delete-faq-btn edit-title-btn" style="position:absolute; top:0; right:0; background-color:#b93030;">Eliminar</button>
                      </div>
                      <textarea class="faq-answer"
                        placeholder="Escribe tu respuesta aqu√≠..."
                        style="margin-top: 2vh; min-height: 1vh; resize: none; overflow-y: hidden; line-height: 1; font-size: 1.5vh;"></textarea>
                    </div>
                  </div>
                  <div id = "addFaqBtnContainer">
                    <!-- Bot√≥n para a√±adir un nuevo bloque pregunta-respuesta -->
                    <button class="a√±adir-faq-btn" id="addFaqBtn" style="margin-top: 2vh;">
                      A√±adir nueva pregunta-respuesta
                    </button>
                  </div>
                </div>
                <!-- Bot√≥n de enviar al final -->
                <button class="send-button" style="margin-top: 2vh;">Enviar</button>
              </div>
            </div>
          </div>
          <!-- Flecha derecha para abrir formPage -->
          <div class="arrow-right" id="arrowRight">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                 stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                 viewBox="0 0 24 24">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- FORM-PAGE (segunda pantalla deslizante) -->
    <div class="form-page slide-out-right" id="formPage">
      

      <!-- Contenedor flex que pone DOS CUADROS uno al lado del otro -->
      <div class="forms-row">
        <!-- Flecha a la izquierda, afuera de ambos \"cuadrados\" -->
        <div class="arrow-left" id="arrowLeft">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none"
              stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              viewBox="0 0 24 24">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
        </div>
        <!-- Primer \"cuadrado\" => Datos de Usuario -->
        <div class="form-container">
  
        <!-- Segundo \"cuadrado\" => Informaci√≥n de la Tienda -->
        <div class="form-container">
          <h2>Informaci√≥n de la Tienda</h2>

          <div class="form-group">
            <label for="tiendaName">Nombre de la Tienda</label>
            <input type="text" id="tiendaName" value="" />
          </div>

          <div class="form-group">
            <label for="tiendaUrl">URL</label>
            <input type="text" id="tiendaUrl" value="" />
          </div>

          <div class="form-group">
            <label for="tiendaEmail">Email</label>
            <input type="email" id="tiendaEmail" value="" />
          </div>

          <div class="form-group">
            <label for="tiendaPhone">Tel√©fono</label>
            <input type="tel" id="tiendaPhone" value="" />
          </div>

          <div class="form-group buttons-container">
            <button class="save-button" id="saveStoreBtn">Guardar Tienda</button>
            <button class="delete-button" id="deleteStoreBtn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   width="20" height="20" fill="none" stroke="currentColor"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6L18.335 19.03A2 2 0 0 1 16.34 21H7.66a2 2 0 0 1-1.994-1.97L5 6"></path>
                <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function() {
      const params   = new URLSearchParams(window.location.search);
      const token    = params.get("token");
      const tiendaId = params.get("tienda_id");
      const nombre   = params.get("nombre");
      const email    = params.get("email");

      if (token && tiendaId) {
        // Guardamos TODO en localStorage, con la clave unificada "token"
        localStorage.setItem("token", token);
        localStorage.setItem("tienda_id", tiendaId);
        localStorage.setItem("tienda_nombre", nombre);
        localStorage.setItem("tienda_email", email);
        // Limpiamos la URL para que no se vean los par√°metros
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      } else {
        // Si no vengo con token en la URL, chequear localStorage:
        const storedToken = localStorage.getItem("token");
        const storedTiendaId = localStorage.getItem("tienda_id");

        if (!storedToken || !storedTiendaId) {
          // Si no hay nada en localStorage, redirijo a login
          window.location.href = "http://localhost:3000/index.html";
        }
      }
    })();
  </script>
  <script>
    /***********************************************
     * 0) DETECCI√ìN DE TIENDA Y CONFIGURACIONES
    ***********************************************/
    const token = localStorage.getItem("token");
    const tiendaId = localStorage.getItem("tienda_id");

    if (!token || !tiendaId) {
      window.location.href = "http://localhost:3000/index.html";
    }
    function mostrarModalSesionCaducada() {
      const modal = document.getElementById("session-expired-modal");
      modal.style.display = "flex";

      document.getElementById("cerrar-modal-sesion").onclick = () => {
        modal.style.display = "none";
        // Puedes redirigir si quieres
        window.location.href = "http://localhost:3000/index.html";
      };
    }
    function tokenExpiraEnMenosDe(minutos = 10) {
      if (!token) return true;

      try {
        const payload = JSON.parse(atob(token.split(".")[1]));
        const expMs = payload.exp * 1000;
        return expMs - Date.now() < minutos * 60 * 1000;
      } catch {
        return true;  // si el token est√° corrupto, asumimos que expira pronto
      }
    }
    async function renovarToken() {
      const oldToken = localStorage.getItem("token");
      if (!oldToken) throw new Error("No hay token para renovar");

      const res = await fetch("https://sincere-musical-squid.ngrok-free.app/api/auth/refresh_token", {
        method: "POST",
        headers: { Authorization: `Bearer ${oldToken}` },
      });

      if (!res.ok) {
        throw new Error("No se pudo renovar el token");
      }

      const { access_token } = await res.json();
      localStorage.setItem("token", access_token);
      console.log("üîÅ Token renovado");
    }

    async function fetchWithAuth(input, init = {}) {
      // 1. Comprobar si el token est√° cerca de caducar
      if (tokenExpiraEnMenosDe(10)) {
        
        try {
          await renovarToken();  // Intenta renovar token
        } catch (err) {
          console.error("‚ö†Ô∏è Error renovando token:", err);
          mostrarModalSesionCaducada();  // Mostrar modal personalizado
          return Promise.reject("Sesi√≥n caducada");
        }
      }

      // 2. Obtener token actualizado
      const token = localStorage.getItem("token");
      if (!token) {
        mostrarModalSesionCaducada();
        return Promise.reject("No hay token");
      }

      // 3. Agregar el token a los headers
      init.headers = {
        ...(init.headers || {}),
        "Authorization": `Bearer ${token}`,
      };

      // 4. Hacer la petici√≥n
      const res = await fetch(input, init);

      // 5. Si el token ya estaba caducado o inv√°lido
      if (res.status === 401) {
        mostrarModalSesionCaducada();
        return Promise.reject("Sesi√≥n caducada");
      }

      // 6. Devolver la respuesta si todo fue bien
      return res;
    }

    // ‚Äî‚Äî Bloque III: Cargar URL y Tel√©fono de la tienda (si ya existen) ‚Äî‚Äî  
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const storeRes = await fetchWithAuth(
          "https://sincere-musical-squid.ngrok-free.app/api/stores/me",
          { method: "GET" }
        );
        if (storeRes.ok) {
          const store = await storeRes.json();
          // Pre-llenar URL y Tel√©fono (los otros dos ya vienen por la URL)
          document.getElementById("tiendaName").value  = store.name  || "";
          document.getElementById("tiendaEmail").value = store.email || "";
          document.getElementById("tiendaUrl").value   = store.url   || "";
          document.getElementById("tiendaPhone").value = store.phone || "";
        }
      } catch (err) {
        console.warn("No hubo datos previos de tienda:", err);
        // Si no existe, dejamos los campos en blanco para crear/editar
      }
    });

    // ‚Äî‚Äî Bloque IV: Guardar y Eliminar tienda desde el formulario derecho ‚Äî‚Äî  
    document.getElementById('saveStoreBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const tiendaId = localStorage.getItem("tienda_id");
        const data = {
          name:  document.getElementById("tiendaName").value.trim(),
          url:   document.getElementById("tiendaUrl").value.trim(),
          email: document.getElementById("tiendaEmail").value.trim(),
          phone: document.getElementById("tiendaPhone").value.trim()
        };
        const resp = await fetchWithAuth(
          `https://sincere-musical-squid.ngrok-free.app/api/tiendas/editar_tienda/${tiendaId}`,
          { method: "PUT", body: JSON.stringify(data) }
        );
        if (!resp.ok) {
          const err = await resp.json();
          alert("Error al guardar la tienda: " + (err.detail || resp.status));
          return;
        }
        alert("Tienda guardada correctamente");
      } catch (error) {
        console.error("Error guardando tienda:", error);
        alert("Hubo un error al guardar la tienda");
      }
    });

    document.getElementById('deleteStoreBtn').addEventListener('click', async () => {
      if (!confirm("¬øEst√°s seguro de que deseas eliminar la tienda?")) return;
      try {
        const resp = await fetchWithAuth(
          "https://sincere-musical-squid.ngrok-free.app/api/stores/eliminar_tienda/",
          { method: "DELETE" }
        );
        if (!resp.ok) throw new Error("Error al eliminar tienda");
        alert("Tienda eliminada");
        window.location.href = "http://localhost:3000/index.html";
      } catch (error) {
        console.error("Error eliminando tienda:", error);
        alert("No se pudo eliminar la tienda");
      }
    });

    function showTooltip(event, message) {
      const tooltip = document.createElement('div');
      tooltip.textContent = message;
      tooltip.style.position = 'absolute';
      tooltip.style.backgroundColor = '#333';
      tooltip.style.color = '#fff';
      tooltip.style.padding = '1vh 2vh';
      tooltip.style.borderRadius = '1vh';
      tooltip.style.fontSize = '1.8vh';
      tooltip.style.pointerEvents = 'none';
      tooltip.style.zIndex = 9999;

      // Posicionar cerca del cursor
      tooltip.style.left = event.pageX + 'px';
      tooltip.style.top  = event.pageY + 'px';
      document.body.appendChild(tooltip);

      setTimeout(() => tooltip.remove(), 2000);
    }

    /***********************************************
     * 1) ABRIR FORMULARIO DE A√ëADIR TIENDA (si no hay)
    ***********************************************/
    const noStoreBox = document.getElementById('noStoreBox');
    const newStoreFormPage = document.getElementById('newStoreFormPage');
    const storePage = document.getElementById('storePage');

    if (noStoreBox) {
      noStoreBox.addEventListener('click', () => {
        // Mostramos la form-page 2 para crear tienda
        // Ocultamos la store-page con slide-out
        storePage.classList.add('slide-out-left');
        newStoreFormPage.classList.remove('hidden');
        newStoreFormPage.classList.remove('slide-out-right');
        newStoreFormPage.classList.add('slide-in-left');
      });
    }

    // Toggle onlyOnline => oculta/ense√±a campos
    const onlyOnline = document.getElementById('onlyOnline');
    const addressFields = document.getElementById('addressFields');
    if (onlyOnline) {
      onlyOnline.addEventListener('change', () => {
        addressFields.style.display = onlyOnline.checked ? 'none' : 'block';
      });
      addressFields.style.display = onlyOnline.checked ? 'none' : 'block';
    }

    /****************************************
     * 4) Flecha DERECHA => DESLIZAR formPage
    ****************************************/
    const arrowRight = document.getElementById('arrowRight');
    const arrowLeft  = document.getElementById('arrowLeft');
    const formPage   = document.getElementById('formPage');

    arrowRight.addEventListener('click', () => {
      storePage.classList.add('slide-out-left');
      formPage.classList.remove('slide-out-right');
      formPage.classList.add('slide-in-left');
    });

    arrowLeft.addEventListener('click', () => {
      storePage.classList.remove('slide-out-left');
      formPage.classList.remove('slide-in-left');
      formPage.classList.add('slide-out-right');
    });

    /****************************************
     * 4) Expansi√≥n / Contracci√≥n de tarjetas
    ****************************************/
    const cardsGrid   = document.getElementById('cardsGrid');
    const allCards    = document.querySelectorAll('.card');
    const mainHeading = document.getElementById('mainHeading');

    allCards.forEach((card) => {
      const arrowCollapse = card.querySelector('.arrow-collapse');
      const cardTitle = card.querySelector("h2");
      const policyTitle = cardTitle.textContent.trim();
      card.addEventListener('click', async (e) => {
        if (e.target.closest('.arrow-collapse')) {
          return;
        }
        if (!card.classList.contains('expanded')) {
          try{
            const response = await fetchWithAuth(`https://sincere-musical-squid.ngrok-free.app/api/policies/get?policy_name=${policyTitle}`, {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                }
              })
              .then(response => response.json())
              .then(data => {
                if (data.found) {
                  console.log(data);
                  const preservedArrow = arrowCollapse ? arrowCollapse.cloneNode(true) : null;
                  const preservedTitle = cardTitle ? cardTitle.cloneNode(true) : null;
                  card.innerHTML = "";
                  if (preservedArrow) card.appendChild(preservedArrow);
                  if (preservedTitle) card.appendChild(preservedTitle);

                  if(policyTitle=="Preguntas Frecuentes"){
                    // Crear el contenedor expand-content
                    const expandContent = document.createElement("div");
                    expandContent.classList.add("expand-content");

                    // Crear el p√°rrafo informativo
                    const infoP = document.createElement("p");
                    infoP.style.marginBottom = "4vh";
                    infoP.style.marginTop = "4vh";
                    infoP.style.textAlign = "center";
                    infoP.textContent = "En esta secci√≥n se encuentran preguntas frecuentes las cuales puedes responder para agilizar las respuestas del bot. Tambi√©n puedes a√±adir las tuyas propias.";
                    expandContent.appendChild(infoP);

                    // Crear el contenedor de FAQs
                    const faqContainer = document.createElement("div");
                    faqContainer.id = "faqContainer";

                    // Contenedor que agrupa todos los bloques FAQ
                    const faqBlocks = document.createElement("div");
                    faqBlocks.id = "faqBlocks";

                    // Iterar sobre cada elemento del content (lista de diccionarios)
                    data.content.forEach(faq => {
                      // Cada faq es un objeto con una √∫nica clave (la pregunta) y su valor (la respuesta)
                      for (let question in faq) {
                        const answer = faq[question];

                        // Crear el contenedor del bloque FAQ
                        const faqBlock = document.createElement("div");
                        faqBlock.classList.add("faq-block");
                        faqBlock.style.position = "relative";
                        faqBlock.style.marginBottom = "3vh";
                        faqBlock.style.paddingLeft = "1vh";

                        // Contenedor interno para la pregunta y botones
                        const innerDiv = document.createElement("div");

                        // Crear el p√°rrafo con el texto de la pregunta
                        const pQuestion = document.createElement("p");
                        pQuestion.classList.add("faq-question-text");
                        pQuestion.style.width = "fit-content";
                        pQuestion.textContent = question;

                        // Crear el bot√≥n "Editar"
                        const editBtn = document.createElement("button");
                        editBtn.classList.add("edit-faq-btn", "edit-title-btn");
                        editBtn.style.position = "absolute";
                        editBtn.style.top = "0";
                        editBtn.style.right = "10vh";
                        editBtn.textContent = "Editar";

                        // Crear el bot√≥n "Eliminar"
                        const deleteBtn = document.createElement("button");
                        deleteBtn.classList.add("delete-faq-btn", "edit-title-btn");
                        deleteBtn.style.position = "absolute";
                        deleteBtn.style.top = "0";
                        deleteBtn.style.right = "0";
                        deleteBtn.style.backgroundColor = "#b93030";
                        deleteBtn.textContent = "Eliminar";

                        // Agregar la pregunta y los botones al contenedor interno
                        innerDiv.appendChild(pQuestion);
                        innerDiv.appendChild(editBtn);
                        innerDiv.appendChild(deleteBtn);

                        // Crear el textarea para la respuesta
                        const textarea = document.createElement("textarea");
                        textarea.classList.add("faq-answer");
                        textarea.placeholder = "Escribe tu respuesta aqu√≠...";
                        textarea.style.marginTop = "2vh";
                        textarea.style.minHeight = "1vh";
                        textarea.style.resize = "none";
                        textarea.style.overflowY = "hidden";
                        textarea.style.lineHeight = "1";
                        textarea.style.fontSize = "1.5vh";
                        textarea.value = answer;

                        // Agregar el contenedor interno y el textarea al bloque FAQ
                        faqBlock.appendChild(innerDiv);
                        faqBlock.appendChild(textarea);

                        // Agregar el bloque FAQ al contenedor de bloques
                        faqBlocks.appendChild(faqBlock);
                      }
                    });

                    // Agregar el contenedor de bloques al contenedor principal de FAQs
                    faqContainer.appendChild(faqBlocks);

                    // Crear el contenedor para el bot√≥n de a√±adir FAQ
                    const addFaqBtnContainer = document.createElement("div");
                    addFaqBtnContainer.id = "addFaqBtnContainer";

                    const addFaqBtn = document.createElement("button");
                    addFaqBtn.classList.add("a√±adir-faq-btn");
                    addFaqBtn.id = "addFaqBtn";
                    addFaqBtn.style.marginTop = "2vh";
                    addFaqBtn.textContent = "A√±adir nueva pregunta-respuesta";

                    addFaqBtnContainer.appendChild(addFaqBtn);
                    faqContainer.appendChild(addFaqBtnContainer);

                    // Agregar el contenedor de FAQs al contenedor expand-content
                    expandContent.appendChild(faqContainer);

                    // Crear el bot√≥n de enviar final
                    const finalSendBtn = document.createElement("button");
                    finalSendBtn.classList.add("send-button");
                    finalSendBtn.style.marginTop = "2vh";
                    finalSendBtn.textContent = "Enviar";

                    expandContent.appendChild(finalSendBtn);

                    // Agregar expand-content al card (despu√©s de la flecha y el t√≠tulo)
                    card.appendChild(expandContent);
                    if (preservedArrow) {
                      console.log("preservedArrow");
                      preservedArrow.addEventListener('click', (e) => {
                        console.log("resultContainer");
                        let resultContainer = card.querySelector(".result-container");
                        if (resultContainer) {
                          resultContainer.style.display = "none";
                        }
                        expandContent.style.display = "none";
                        e.stopPropagation();
                        collapseCard(card);
                      });
                    }
                    addFaqBtn.addEventListener('click', () => {
                      const newBlock = document.createElement('div');
                      newBlock.classList.add('faq-block');
                      newBlock.style.position = 'relative';
                      newBlock.style.marginBottom = '3vh';
                      newBlock.style.paddingLeft = '1vh';

                      newBlock.innerHTML = `
                        <div>
                          <p class="faq-question-text" contenteditable="true" style="width: fit-content;">Nueva pregunta</p>
                          <button class="edit-faq-btn edit-title-btn" style="position:absolute; top:0; right:10vh;">Guardar</button>
                          <button class="delete-faq-btn edit-title-btn" style="position:absolute; top:0; right:0; background-color:#b93030;">Eliminar</button>
                        </div>
                        <textarea class="faq-answer" placeholder="Escribe tu respuesta aqu√≠..." style="margin-top: 2vh; min-height: 1vh; resize: none; overflow-y: hidden; line-height: 1; font-size: 1.5vh;"></textarea>
                      `;
                      faqBlocks.append(newBlock);
                      addFaqBtn.scrollIntoView(false);
                    });
                    procesar_faq(card);
                  }else{
                  
                    const buttoneditarinfo = document.createElement("button");
                    buttoneditarinfo.classList.add("edit-title-btn");
                    buttoneditarinfo.textContent = "Editar informaci√≥n";
                    buttoneditarinfo.style.position = "relative";
                    buttoneditarinfo.style.fontSize = "2vh";
                    const buttona√±adirinfo = document.createElement("button");
                    buttona√±adirinfo.classList.add("edit-title-btn");
                    buttona√±adirinfo.style.position = "relative";
                    buttona√±adirinfo.style.fontSize = "2vh";
                    buttona√±adirinfo.textContent = "A√±adir informacion nueva";

                    const expandcontentconpolitica = document.createElement("div");
                    expandcontentconpolitica.classList.add("expand-content");
                    expandcontentconpolitica.appendChild(buttoneditarinfo);
                    expandcontentconpolitica.appendChild(buttona√±adirinfo);


                    // Style to fill the container
                    expandcontentconpolitica.style.width = "100%";
                    expandcontentconpolitica.style.height = "100%";
                    expandcontentconpolitica.style.display = "flex";
                    expandcontentconpolitica.style.flex = "1";
                    expandcontentconpolitica.style.justifyContent = "center";
                    expandcontentconpolitica.style.alignItems = "center";
                    expandcontentconpolitica.style.gap = "4vh";

                    card.appendChild(expandcontentconpolitica);
                    
                    if (buttoneditarinfo) {
                      buttoneditarinfo.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        
                        try {
                          // Clear the card content but preserve arrow and title
                          card.innerHTML = "";
                          if (preservedArrow) card.appendChild(preservedArrow);
                          if (preservedTitle) card.appendChild(preservedTitle);
                          
                          // Create expand-content div with textarea and send button
                          const expandContent = document.createElement("div");
                          expandContent.classList.add("expand-content");
                          
                          const textarea = document.createElement("textarea");
                          textarea.placeholder = "Escribe tu texto aqui...";
                          if (data.found && data.content) {
                            textarea.value = data.content;
                          }
                          
                          const sendButton = document.createElement("button");
                          sendButton.classList.add("send-button");
                          sendButton.textContent = "Enviar";
                          
                          // Create loading spinner (hidden initially)
                          const loadingSpinner = document.createElement("div");
                          loadingSpinner.classList.add("loading-spinner", "hidden");
                          loadingSpinner.innerHTML = `
                            <div class="loader">
                              <p>Estamos</p>
                              <div class="words">
                                <span class="word">comprobando que tus datos est√©n completos...</span>
                                <span class="word">revisando que no falte nada...</span>
                                <span class="word">comparando con nuestra base de datos...</span>
                                <span class="word">preparando el feedback...</span>
                                <span class="word">comprobando que tus datos est√©n completos...</span>
                              </div>
                            </div>
                          `;
                          
                          // Add all elements to expandContent
                          expandContent.appendChild(textarea);
                          expandContent.appendChild(sendButton);
                          expandContent.appendChild(loadingSpinner);
                          
                          // Add expandContent to card
                          card.appendChild(expandContent);
                          
                          procesar_politica(card);

                          // Restore arrow collapse functionality
                          if (preservedArrow) {
                            preservedArrow.addEventListener('click', (e) => {
                              let resultContainer = card.querySelector(".result-container");
                              if (resultContainer) {
                                resultContainer.style.display = "none";
                              }
                              e.stopPropagation();
                              collapseCard(card);
                            });
                          }
                        } catch (error) {
                          console.error("Error al obtener la pol√≠tica para editar:", error);
                        }
                      });
                    }
                    if(buttona√±adirinfo){
                      buttona√±adirinfo.addEventListener('click', async (e) => {
                        // Clear the card content but preserve arrow and title
                        card.innerHTML = "";
                        if (preservedArrow) card.appendChild(preservedArrow);
                        if (preservedTitle) card.appendChild(preservedTitle);

                        // Create expand-content div with textarea and send button
                        const expandContent = document.createElement("div");
                        expandContent.classList.add("expand-content");

                        // Asignamos el contenido completo en innerHTML
                        expandContent.innerHTML = `
                          <p style="margin-bottom: 4vh; margin-top: 4vh; text-align: center;">
                            En esta secci√≥n se encuentran preguntas frecuentes las cuales puedes responder
                            para agilizar las respuestas del bot. Tambi√©n puedes a√±adir las tuyas propias.
                          </p>
                          <div id="faqContainer" >
                            <div id="faqBlocks">
                              <!-- Pregunta/Respuesta 1 -->
                              <div class="faq-block" style="position: relative; margin-bottom: 3vh; padding-left: 1vh;">
                                <div>
                                  <p class="faq-question-text" style="width: fit-content;" contentEditable="true">Escribe aqui el texto</p>
                                  <button class="edit-faq-btn edit-title-btn" style="position: absolute; top: 0; right: 10vh;">Guardar</button>
                                  <button class="delete-faq-btn edit-title-btn" style="position: absolute; top: 0; right: 0; background-color: #b93030;">Eliminar</button>
                                </div>
                                <textarea class="faq-answer"
                                  placeholder="Escribe tu respuesta aqu√≠..."
                                  style="margin-top: 2vh; min-height: 1vh; resize: none; overflow-y: hidden; line-height: 1; font-size: 1.5vh;"></textarea>
                              </div>
                            </div>
                            <div id="addFaqBtnContainer">
                              <!-- Bot√≥n para a√±adir un nuevo bloque pregunta-respuesta -->
                              <button class="a√±adir-faq-btn" id="addFaqBtn" style="margin-top: 2vh;">
                                A√±adir nueva pregunta-respuesta
                              </button>
                            </div>
                          </div>
                          <!-- Bot√≥n de enviar al final -->
                          <button class="send-button" style="margin-top: 2vh;">Enviar</button>
                        `;
                        card.appendChild(expandContent);
                        const addFaqBtn = expandContent.querySelector("#addFaqBtn")
                        const faqBlocks= expandContent.querySelector("#faqBlocks")

                        addFaqBtn.addEventListener('click', () => {
                          console.log("A√±adir nueva pregunta");
                          const newBlock = document.createElement('div');
                          newBlock.classList.add('faq-block');
                          newBlock.style.position = 'relative';
                          newBlock.style.marginBottom = '3vh';
                          newBlock.style.paddingLeft = '1vh';

                          newBlock.innerHTML = `
                            <div>
                              <p class="faq-question-text" contenteditable="true" style="width: fit-content;">Nueva pregunta</p>
                              <button class="edit-faq-btn edit-title-btn" style="position:absolute; top:0; right:10vh;">Guardar</button>
                              <button class="delete-faq-btn edit-title-btn" style="position:absolute; top:0; right:0; background-color:#b93030;">Eliminar</button>
                            </div>
                            <textarea class="faq-answer" placeholder="Escribe tu respuesta aqu√≠..." style="margin-top: 2vh; min-height: 1vh; resize: none; overflow-y: hidden; line-height: 1; font-size: 1.5vh;"></textarea>
                          `;
                          faqBlocks.append(newBlock);
                          addFaqBtn.scrollIntoView(false);
                        });
                        card.attributes["faq"] = "faq";
                        procesar_faq(card);
                      });
                    }
                    if (preservedArrow) {
                      console.log("preservedArrow");
                      preservedArrow.addEventListener('click', (e) => {
                        let resultContainer = card.querySelector(".result-container");
                        if (resultContainer) {
                          resultContainer.style.display = "none";
                        }
                        expandcontentconpolitica.style.display = "none";
                        e.stopPropagation();
                        collapseCard(card);
                      });
                    }
                  }
                }
              })
              .catch(error => console.error("Error al obtener la pol√≠tica:", error));
            expandCard(card);
          } catch (error) {
            console.error("Error al procesar la pol√≠tica:", error);
          }
        }else{
          expandCard(card);
        }
      });
      if (arrowCollapse) {
        arrowCollapse.addEventListener('click', (e) => {
          e.stopPropagation();
          collapseCard(card);
        });
      }
    });

    function expandCard(card) {
      document.querySelectorAll('.card.expanded').forEach((c) => {
        c.classList.remove('expanded');
      });
      card.classList.add('expanded');
      cardsGrid.classList.add('expanded');
      storePage.classList.add('shifted-up');
      arrowRight.classList.add('hidden');
      mainHeading.classList.add('hidden-heading');
    }

    function collapseCard(card) {
      card.classList.remove('expanded');
      if (!document.querySelector('.card.expanded')) {
        cardsGrid.classList.remove('expanded');
        storePage.classList.remove('shifted-up');
        arrowRight.classList.remove('hidden');
        mainHeading.classList.remove('hidden-heading');
      }
    }

    /****************************************
     * 6) Logout (usuario)
    ****************************************/
    const userMenuButton   = document.getElementById('storeNameCorner');
    const userDropdownMenu = document.getElementById('userDropdownMenu');
    const logoutBtn       = document.getElementById('logoutBtn');

    userMenuButton.addEventListener('click', (event) => {
      event.preventDefault();
      userDropdownMenu.classList.toggle('hidden');
    });
    if (logoutBtn) {
        logoutBtn.addEventListener("click", () => {
        // Elimina el token guardado
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        localStorage.removeItem("store");

        // Redirige al login
        window.location.href = `${window.location.origin}/index.html`;
      });
    }
    document.addEventListener('click', (event) => {
      if (userDropdownMenu &&
          !userDropdownMenu.contains(event.target) &&
          !userMenuButton.contains(event.target)) {
        userDropdownMenu.classList.add('hidden');
      }
    });
  </script>
  <script>
    /****************************************
     * 6) FAQS (preguntas frecuentes)
    ****************************************/
    // 1) EDITAR y ELIMINAR (delegaci√≥n de eventos)
    document.addEventListener('click', (e) => {
      const btn = e.target;

      // EDITAR FAQ
      if (btn.matches('.edit-faq-btn')) {
        const faqBlock = btn.closest('.faq-block');
        const questionP = faqBlock.querySelector('.faq-question-text');

        if (questionP.isContentEditable) {
          questionP.contentEditable = "false";
          btn.textContent = "Editar";
        } else {
          questionP.contentEditable = "true";
          btn.textContent = "Guardar";
        }
      }

      // ELIMINAR FAQ
      if (btn.classList.contains('delete-faq-btn')) {
        const faqBlock = btn.closest('.faq-block');
        if (confirm('¬øSeguro que deseas eliminar esta pregunta?')) {
          faqBlock.remove();
        }
      }
    });

    // Auto resize textarea
    function autoResizeTextarea(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    }

    document.addEventListener('input', (e) => {
      if (e.target.classList.contains('faq-answer')) {
        autoResizeTextarea(e.target);
      }
    });

    // A√±adir nueva pregunta
    const faqBlocks = document.getElementById('faqBlocks');
    const addFaqBtn = document.getElementById('addFaqBtn');

    addFaqBtn.addEventListener('click', () => {
      console.log("A√±adir nueva pregunta");
      const newBlock = document.createElement('div');
      newBlock.classList.add('faq-block');
      newBlock.style.position = 'relative';
      newBlock.style.marginBottom = '3vh';
      newBlock.style.paddingLeft = '1vh';

      newBlock.innerHTML = `
        <div>
          <p class="faq-question-text" contenteditable="true" style="width: fit-content;">Nueva pregunta</p>
          <button class="edit-faq-btn edit-title-btn" style="position:absolute; top:0; right:10vh;">Guardar</button>
          <button class="delete-faq-btn edit-title-btn" style="position:absolute; top:0; right:0; background-color:#b93030;">Eliminar</button>
        </div>
        <textarea class="faq-answer" placeholder="Escribe tu respuesta aqu√≠..." style="margin-top: 2vh; min-height: 1vh; resize: none; overflow-y: hidden; line-height: 1; font-size: 1.5vh;"></textarea>
      `;
      faqBlocks.append(newBlock);
      addFaqBtn.scrollIntoView(false);
    });

    // Auto resize FAQ answers on input
    faqBlocks.addEventListener('input', (e) => {
      if (e.target.classList.contains('faq-answer')) {
        autoResizeTextarea(e.target);
      }
    });


    /****************************************
     * 7) ENVIAR POL√çTICAS (devoluciones, env√≠os, info)
    ****************************************/

    document.addEventListener('DOMContentLoaded', () => {
      // Seleccionamos TODAS las tarjetas que tengan data-policy-type
      const policyCards = document.querySelectorAll('.card[data-policy-type]');
      const faqCards = document.querySelectorAll('.card[faq]');


      policyCards.forEach(card => {
        procesar_politica(card);
      });

      faqCards.forEach(card => {
        procesar_faq(card);
      });
    });

    function procesar_politica(card) {
      const policyTitle = card.querySelector('h2').textContent.trim(); // Obtener el t√≠tulo de la card expandida
      const textarea   = card.querySelector('textarea');
      const sendBtn    = card.querySelector('.send-button');
      const arrow      = card.querySelector('.arrow-collapse');
      const spinner    = card.querySelector('.loading-spinner');
      
      // Aqu√≠ creamos un contenedor donde mostraremos la lista de "faltantes" o mensajes
      // (puedes darle la clase o estilos que quieras)
      const resultContainer = document.createElement('div');
      resultContainer.classList.add('result-container');
      resultContainer.style.display = 'flex';
      resultContainer.style.flexDirection = 'column';
      resultContainer.style.alignItems = 'center';
      resultContainer.style.flexWrap = 'wrap';
      resultContainer.style.paddingTop = '2vh';
      // Lo insertamos antes del textarea, por ejemplo:
      textarea.parentNode.insertBefore(resultContainer, textarea);

      // Cuando pulsamos "Enviar"
      sendBtn.addEventListener('click', async () => {
        const content = textarea.value.trim();
        if (!content) {
          alert("No has escrito nada");
          return;
        }

        try {
          // 1) Ocultar lo que el usuario no debe tocar (textarea, bot√≥n, flecha)
          textarea.classList.add('hidden');
          sendBtn.classList.add('hidden');
          if (arrow) arrow.classList.add('hidden'); 
          // 2) Mostrar spinner
          spinner.classList.remove('hidden');

          // Limpiamos el contenedor de resultados
          resultContainer.innerHTML = "";

          const response = await fetchWithAuth("https://sincere-musical-squid.ngrok-free.app/api/policies/process", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              policy_type: policyTitle,
              content: content
            })
          });

          if (!response.ok) {
            throw new Error("Error HTTP: " + response.status);
          }
          
          const data = await response.json();
          // 2) Dependiendo del estado:
          if (data.status === "complete") {
            const successMsg = document.createElement('p');
            successMsg.textContent = "¬°Felicidades, Ya tienes tu informaci√≥n actualizada! üéâ";
            successMsg.style.textAlign = 'center';
            successMsg.style.fontWeight = 'bold';
            successMsg.style.fontSize = '2em';
            resultContainer.appendChild(successMsg);
            if (arrow) arrow.classList.remove('hidden');
            
          } else if (data.status === "incomplete") {
            const infoMsg = document.createElement('p');
            infoMsg.textContent = "Faltan los siguientes elementos por a√±adir:";
            // Creamos el contenedor principal del checklist
            const checklistContainer = document.createElement('div');
            checklistContainer.id = "checklist"; // <-- para que aplique el CSS anterior

            // Iteramos cada 'item' faltante
            data.missing_info.forEach((item, index) => {
              // Creamos un id √∫nico para el <input> y su <label>
              const checkboxId = `missingItem_${index}`;

              // 1) input[type="checkbox"]
              const inputEl = document.createElement('input');
              inputEl.type = 'checkbox';
              inputEl.value = item;        // Podr√≠as usar item como valor
              inputEl.name = "missing_r";  // el name que gustes
              inputEl.id = checkboxId;

              // 2) label for="checkboxId"
              const labelEl = document.createElement('label');
              labelEl.setAttribute('for', checkboxId);
              // Aqu√≠ lo normal es que el texto sea el "item" que falte
              // o que pongas "Falta: item"
              labelEl.textContent = item;

              // A√±adir todo dentro del checklistContainer
              checklistContainer.appendChild(inputEl);
              checklistContainer.appendChild(labelEl);
            });

            // Insertamos el checklistContainer en el "resultContainer"
            resultContainer.appendChild(infoMsg);
            resultContainer.appendChild(checklistContainer);

            // Despu√©s volvemos a poner el textarea y bot√≥n para que el usuario
            // rellene lo que falta, etc.
            textarea.classList.remove('hidden');
            sendBtn.classList.remove('hidden');
            if (arrow) arrow.classList.remove('hidden');
          }else {
            // Respuesta inesperada
            alert("Respuesta inesperada del servidor: " + JSON.stringify(data));
            textarea.classList.remove('hidden');
            sendBtn.classList.remove('hidden');
            if (arrow) arrow.classList.remove('hidden');
          }
        } catch (error) {
          console.error(error);
          alert("Ocurri√≥ un error al enviar la pol√≠tica: " + error.message);
          textarea.classList.remove('hidden');
          sendBtn.classList.remove('hidden');
          if (arrow) arrow.classList.remove('hidden');
        } finally {
          // 4) Ocultar el spinner pase lo que pase
          spinner.classList.add('hidden');
        }
      });
    }

    function procesar_faq(card) {
      const policyTitle = card.querySelector('h2').textContent.trim();
      const sendBtn     = card.querySelector('.send-button');
      const arrow       = card.querySelector('.arrow-collapse');
      const spinner     = card.querySelector('.loading-spinner');
      // Si tienes un contenedor de resultados ya definido en el card, lo usas; sino, lo creas.
      const resultContainer = document.createElement('div');
      resultContainer.classList.add('result-container');
      // Insertar el resultContainer debajo del t√≠tulo
      const cardTitle = card.querySelector('h2');
      cardTitle.insertAdjacentElement('afterend', resultContainer);

      sendBtn.addEventListener('click', async () => {
        console.log("Procesando FAQ");
        // Recopilamos todos los bloques de pregunta-respuesta dentro de la secci√≥n FAQ
        const faqBlocks = card.querySelectorAll('.faq-block');
        let faqList = [];

        faqBlocks.forEach(block => {
          const questionEl = block.querySelector('.faq-question-text');
          const answerEl   = block.querySelector('.faq-answer');
          if (questionEl && answerEl) {
            const question = questionEl.textContent.trim();
            const answer   = answerEl.value.trim();
            // Puedes agregar validaci√≥n si es necesario (por ejemplo, ignorar vac√≠os)
            faqList.push({ [question]: answer });
          }
        });

        // Validaci√≥n: asegurarse de que se haya ingresado al menos un par pregunta-respuesta
        if (faqList.length === 0) {
          alert("No has ingresado ninguna pregunta-respuesta.");
          return;
        }
        const expandContent = card.querySelector('.expand-content');
        try {
          // Ocultar los elementos que el usuario no debe modificar durante el env√≠o
          const expandContent = card.querySelector('.expand-content');
          if (expandContent) expandContent.classList.add('hidden');
          if (arrow) arrow.classList.add('hidden');
          sendBtn.classList.add('hidden');

          // Mostrar spinner
          if (spinner) spinner.classList.remove('hidden');

          // Limpiar el contenedor de resultados
          resultContainer.innerHTML = "";

          // Enviar los datos al backend, enviando policyTitle y la lista de FAQ
          const response = await fetchWithAuth("https://sincere-musical-squid.ngrok-free.app/api/policies/process", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              policy_type: policyTitle,
              content: faqList
            })
          });

          if (!response.ok) {
            throw new Error("Error HTTP: " + response.status);
          }

          const data = await response.json();

          if (data.status === "complete") {
            const successMsg = document.createElement('p');
            successMsg.textContent = "¬°Felicidades, ya se ha guardado tu informacion! üéâ";
            successMsg.style.textAlign = 'center';
            successMsg.style.fontWeight = 'bold';
            successMsg.style.fontSize = '2em';
            resultContainer.appendChild(successMsg);
            if (arrow) arrow.classList.remove('hidden');
          } else {
            alert("Error al guardar: " + (data.error || "Respuesta inesperada"));
          }
        } catch (error) {
          console.error(error);
          alert("Ocurri√≥ un error al enviar la pol√≠tica: " + error.message);
          expandContent.classList.remove('hidden');
          sendBtn.classList.remove('hidden');
          if (arrow) arrow.classList.remove('hidden');
        } finally {
          // 4) Ocultar el spinner pase lo que pase
          spinner.classList.add('hidden');
        }
      });
    }
  </script>
  <div id="session-expired-modal" style="display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: rgb(42 42 42); padding: 2rem; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
      <h2>Sesi√≥n caducada</h2>
      <p>Tu sesi√≥n ha expirado. Por favor, vuelve a iniciar sesi√≥n para continuar.</p>
      <button id="cerrar-modal-sesion" style="margin-top: 1rem; padding: 0.5rem 1rem; border: none; background: #20ab7a; color: white; border-radius: 5px; cursor: pointer;">
        Entendido
      </button>
    </div>
  </div>
</body>
</html>
